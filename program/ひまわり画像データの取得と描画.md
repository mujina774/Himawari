## [気象衛星ひまわりが撮影した画像データの取得と描画](https://labo-code.com/python/cartopy-himawari/)

気象衛星ひまわりが撮影した画像データは，千葉大学リモートセンシング研究センター (CEReS) のサイトから，FTPで取得できます。FTP でファイルにアクセスしデータを取得するには Python 標準ライブラリの ftp が使用できます。

取得した画像データ（バイナリ）は bzip2 という形式で圧縮されています。したがって，解凍し，バイナリデータを読み込む必要があります。これには，Python 標準ライブラリ bz2 が使用できます。

気象衛星は様々な波長領域に感度を持つセンサーをもっています。今回は，バンド13と呼ばれる中心波長 10.4 μm の赤外線領域の画像データを使用します。夜でも見ることができるのでテレビ等でよく見る雲画像は，赤外線画像であることが多いと思います。詳しい特性については，[気象衛星センターの説明](https://www.data.jma.go.jp/mscweb/ja/prod/band_b13.html)がわかりやすいです。

画像データの緯度・経度，分解能等の情報は，[千葉大学リモートセンシング研究センターのリリースノート](http://www.cr.chiba-u.jp/databases/GEO/H8_9/FD/index_jp_V20190123.html)で公開されています。下の表にデータ名の名前とバンドの対応，解像度の表を示します。これは，[千葉大学リモートセンシング研究センターのリリースノート](http://www.cr.chiba-u.jp/databases/GEO/H8_9/FD/index_jp_V20190123.html) (2022/12/27閲覧）から転載したものです。

| CEReS gridded | ひまわり8/9号バンド | Pixel x Line | 空間解像度 |
| --- | --- | --- | --- |
| EXT 01 | Band03 (0.64 μｍ) | 24000 x 24000 | 0.005 degree (500 m 相当) |
| VIS 01 | Band01 (0.47 μｍ) | 12000 x 12000 | 0.01 degree (1 km 相当) |
| VIS 02 | Band02 (0.51 μｍ) | 12000 x 12000 | 0.01 degree (1 km 相当) |
| VIS 03 | Band04 (0.86 μｍ) | 12000 x 12000 | 0.01 degree (1 km 相当) |
| SIR 01 | Band05 (1.6 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| SIR 02 | Band06 (2.3 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 01 | Band13 (10.4 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 02 | Band14 (11.2 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 03 | Band15 (12.4 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 04 | Band16 (13.3 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 05 | Band07 (3.9 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 06 | Band08 (6.2 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 07 | Band09 (6.9 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 08 | Band10 (7.3 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 09 | Band11 (8.8 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |
| TIR 10 | Band12 (9.6 μｍ) | 6000 x 6000 | 0.02 degree (2 km 相当) |

表1：千葉大学リモートセンシング研究センターが提供するグリッドデータとひまわり8/9号バンドの対応関係と解像度

<table><tbody><tr><td>緯度経度範囲</td><td>東経 85度 – 西経155度 (85E – 155W (205E)), 北緯60度 – 南緯60度 (60N – 60S)</td></tr><tr><td>格納データ仕様</td><td>ヘッダー無し2 byte 符号無し整数 (unsigned short), big endian data order のバイナリデータ</td></tr><tr><td>データ書き出し順</td><td>西 -&gt; 東 (左 -&gt; 右)，北 -&gt; 南（上 -&gt; 下）に書き出し</td></tr><tr><td>格納データ</td><td>気象庁より配信されたひまわりスタンダード(HS) データ内のカウント値そのもの&nbsp;<br><strong>幾何補正で値が入っていないところには例外値として65535 が入る点に注意が必要</strong></td></tr></tbody></table>

表2：画像データの仕様

画像データそのものの値は，デジタルナンバー値 (DN値) とよばれます。DN値を物理的に，より解釈しやすい情報にするための対応表が用意されています。python標準ライブラリのurllibを使って，httpでアクセスし，この対応表をダウンロードしてみます。そして，これを使って，DN値を黒体放射輝度温度になおしてCartopyを使ってデータを描画してみましょう。

## 実装方法

以上述べたことをPythonでコーディングしてみたいと思います。以下に実装例を示します。このコードを好きな名前 (ここでは，`get-and-plot-himawari.py` とします) をつけて，好きなディレクトリ (ここでは，`~/Desktop/LabCode/python/himawari` とします) に保存します。

```python
import bz2
import os
import ftplib
import tarfile
import urllib.request

import cartopy.crs as ccrs
import cartopy.feature as cfeature
import matplotlib.pyplot as plt
import numpy as np


#------------------------------------------------------------------------------
#  千葉大学リモートセンシング研究センターから取得する衛星画像の設定    
date = "20220917" # 8桁の数字で入力する
time = "0000" # 協定世界時刻であることに注意。つまり，日本時間はこれよりも9時間進んでいる
band = "tir" # バンド名 vis, tir 
ch = "01" # チャンネル番号

# 最大，最小の緯度と経度，縦横の画素数
lon_min = 85
lon_max = 205
lat_min = -60
lat_max = 60
n = 6000

# ひまわり画像データの範囲
extent_hmwr = (lon_min, lon_max, lat_min, lat_max)

#------------------------------------------------------------------------------
# ひまわりの画像データを読み込む
# ひまわりデータは千葉大学リモートセンシング研究センターがFTPで提供しているものを利用する。
server = "hmwr829gr.cr.chiba-u.ac.jp"
tail = "fld.geoss.bz2"
fname_hmwr = f"{date}{time}.{band}.{ch}.{tail}"
url = f"{server}/{date[0:6]}/{band.upper()}/{fname_hmwr}"

if not os.path.isfile(fname_hmwr):
    print('*** 画像ファイルをダウンロードします: ', fname_hmwr,)
    ftp = ftplib.FTP(server)
    ftp.login('', '') # anonymousユーザーでログイン
    ftp.cwd(f'gridded/FD/V20190123/{date[0:6]}/{band.upper()}')

    with open(fname_hmwr ,'wb') as fhandle:
        ftp.retrbinary(f'RETR {fname_hmwr}', fhandle.write)
    print('*** 画像ファイルのダウンロードが完了しました: ', fname_hmwr,)

    ftp.quit()


#------------------------------------------------------------------------------
# センサのカウント値を放射輝度へ変換する必要がある。
# そのための変換テーブルをダウンロードする
fname_cnt2tbb = 'count2tbb_v102.tgz'
url = f'http://www.cr.chiba-u.jp/databases/GEO/H8_9/FD/{fname_cnt2tbb}'

# ファイルのダウンロード
if not os.path.isfile(fname_cnt2tbb):
    print("*** 変換テーブルをダウンロードしています：", fname_cnt2tbb)
    urllib.request.urlretrieve(url, fname_cnt2tbb)

# ファイルの解凍
if not os.path.isdir(f'count2tbb_v102'):
    print("*** 変換テーブルを解凍しています")
    with tarfile.open(fname_cnt2tbb, "r:gz") as tarin:
        tarin.extractall()

# カウント値から黒体放射輝度温度(TBB)への変換テーブルの読み込み
print("*** 変換テーブルを読み込みます")
_, cnt2tbb = np.loadtxt(f'count2tbb_v102/{band}.{ch}', unpack=True)

#  標準ライブラリbz2を使用して，ひまわり画像を開く。
with bz2.open(fname_hmwr) as bz2fin:
    buf_cnt = bz2fin.read()
    data_cnt = np.frombuffer(buf_cnt, dtype='>u2').reshape(n, n)
    
    data_tbb = cnt2tbb[data_cnt] # 画像データを変換テーブルで変換する


#------------------------------------------------------------------------------
# プロット
fig = plt.figure(figsize=(294/25.4, 210/25.4))
out_fig_path = f'{date}{time}-himawari_{band}{ch}.png'

fig.text(0.10, 0.97, f"{date} {time}UTC", fontsize=14)
fig.text(0.10, 0.94, f"BAND:{band}, CH:{ch}", fontsize=14)
#  図法の設定 (適宜コメントアウトを外して使ってください)
# mapcrs = ccrs.PlateCarree()
mapcrs = ccrs.NorthPolarStereo(central_longitude=140.0, true_scale_latitude=60.0) # 気象庁「日々の天気図」に近いもの
# mapcrs = ccrs.Robinson(central_longitude=180.0) # ロビンソン図法
# mapcrs = ccrs.Mercator() # メルカトル図法
# mapcrs = ccrs.Mollweide() # モルワイデ図法

ax = fig.add_axes([0.10, 0.10, 0.75, 0.75], projection=mapcrs)


# 海岸線や国境を描画する
ax.add_feature(cfeature.COASTLINE, linewidth=0.5, color="green")
ax.add_feature(cfeature.BORDERS, linewidth=0.5, linestyle=':', color="green")

# 地図を描く緯度経度の範囲の設定
ax.set_extent([117.0, 156.0, 18.0, 61.0], ccrs.PlateCarree())

# ひまわり衛星画像の描画
ax.imshow(data_tbb, origin='upper', extent=extent_hmwr, interpolation='none',cmap="gray_r", transform=ccrs.PlateCarree())

ax.gridlines(xlocs=np.arange(100, 180, 10), 
             ylocs=np.arange(10, 90, 10),
             linestyle='dashed', color='green', linewidth=0.5)

#------------------------------------------------------------------------------
# 図の保存
plt.savefig(out_fig_path, transparent=False)
```

### ******プログラムを実行する******

ターミナルを開き，

```bash
$ cd Desktop/LabCode/python/himawari
```

と入力し，先程プログラムを保存したディレクトリを移動します。あとは以下のコマンドで`get-and-plot-himawari.py`を実行するだけです。（ `$`マークは「プロンプト」です。入力する必要はありません。）

```bash
$ python3 get-and-plot-himawari.py
```

### **実行結果**

`~/Desktop/LabCode/python/himawari` に，まず，202209170000.tir.01.fld.geoss.bz2 がダウンロードされて，次いでcount2tbb\_v102.tgz がダウンロードされます。その後，解凍されてcount2tbbというフォルダができます。最後に，202209170000-himawari\_tir01.png というファイルができて，以下のようになっていれば成功です！

![](https://labo-code.com/wp-content/uploads/2023/01/fig1-1024x731.png)

生成される図

上のプログラムで描画される図は，2022年に史上最強クラスで日本に接近した台風14号を捉えた画像です。2022年9月17日，日本時間9時の段階では，九州の南の海上にあって，台風の眼がくっきり見えます。

![](https://labo-code.com/wp-content/uploads/2023/01/20220917-hibitenkizu.png)

[気象庁ホームページ「日々の天気図」](https://www.data.jma.go.jp/fcd/yoho/hibiten/index.html)より令和4年9月17日の天気図と記事を抜粋。

参考のために，気象庁ホームページより「日々の天気図」から2022年9月17日，日本時間9時の地上天気図を転載しておきます。台風の中心位置に眼があることや，北緯50度付近の雲が低気圧に対応していることがわかります。

## **コードの解説**

上に書いたソースコードの解説をしていきます。

```python
import bz2
import ftplib
import os
import tarfile
import urllib.request

import cartopy.crs as ccrs
import cartopy.feature as cfeature
import matplotlib.pyplot as plt
import numpy as np
```

まず，必要なモジュールをインポートしておきます。上段はPython標準ライブラリです。下段はpipなどで入れたライブラリです。

```python
#------------------------------------------------------------------------------
#  千葉大学リモートセンシング研究センターから取得する衛星画像の設定    
date = "20220917" # 8桁の数字で入力する
time = "0000" # 協定世界時刻であることに注意。つまり，日本時間はこれよりも9時間進んでいる
band = "tir" # バンド名 vis, tir 
ch = "01" # チャンネル番号

# 最大，最小の緯度と経度，縦横の画素数
lon_min = 85
lon_max = 205
lat_min = -60
lat_max = 60
n = 6000

# ひまわり画像データの範囲
extent_hmwr = (lon_min, lon_max, lat_min, lat_max)
```

千葉大学リモートセンシング研究センターからデータを取得しますが，データの日付や時刻，バンド名，チャンネル番号などの設定をします。

日付と時刻は協定世界時であることに注意してください。つまり，日本時間で9時なら，`time` は `0000` としなければなりません。

緯度と経度の範囲，縦横の画素数はデータの仕様に合わせて設定します。これも，千葉大学リモートセンシング研究センターのリリースノートに従って設定します。

```python
#------------------------------------------------------------------------------
# ひまわりの画像データを読み込む
# ひまわりデータは千葉大学リモートセンシング研究センターがFTPで提供しているものを利用する。
server = "hmwr829gr.cr.chiba-u.ac.jp"
tail = "fld.geoss.bz2"
fname_hmwr = f"{date}{time}.{band}.{ch}.{tail}"
url = f"{server}/{date[0:6]}/{band.upper()}/{fname_hmwr}"

if not os.path.isfile(fname_hmwr):
    print('*** 画像ファイルをダウンロードします: ', fname_hmwr,)
    ftp = ftplib.FTP(server)
    ftp.login('', '') # anonymousユーザーでログイン
    ftp.cwd(f'gridded/FD/V20190123/{date[0:6]}/{band.upper()}')

    with open(fname_hmwr ,'wb') as fhandle:
        ftp.retrbinary(f'RETR {fname_hmwr}', fhandle.write)
    print('*** 画像ファイルのダウンロードが完了しました: ', fname_hmwr,)

    ftp.quit()
```

まず，ひまわり画像データをFTPで取得します。Python標準ライブラリであるftplibを使用します。無駄なアクセスを避けるために，ファイルがある場合にはこの部分はスキップします。

```python
#------------------------------------------------------------------------------
# センサのカウント値を放射輝度へ変換する必要がある。
# そのための変換テーブルをダウンロードする
fname_cnt2tbb = 'count2tbb_v102.tgz'
url = f'http://www.cr.chiba-u.jp/databases/GEO/H8_9/FD/{fname_cnt2tbb}'

# ファイルのダウンロード
if not os.path.isfile(fname_cnt2tbb):
    print("*** 変換テーブルをダウンロードしています：", fname_cnt2tbb)
    urllib.request.urlretrieve(url, fname_cnt2tbb)

# ファイルの解凍
if not os.path.isdir(f'count2tbb_v102'):
    print("*** 変換テーブルを解凍しています")
    with tarfile.open(fname_cnt2tbb, "r:gz") as tarin:
        tarin.extractall()

# カウント値から黒体放射輝度温度(TBB)への変換テーブルの読み込み
print("*** 変換テーブルを読み込みます")
_, cnt2tbb = np.loadtxt(f'count2tbb_v102/{band}.{ch}', unpack=True)
```

この部分は，センサのカウント値から放射輝度温度に変換するテーブルをダウンロードする部分です。httpでアクセスできるので，urllibをつかって取得します。この部分も，無駄なアクセスを避けるために，すでにある場合は実行しません。ファイルは tar で圧縮されているので，tarfile を使用して現在のディレクトリ上に解凍します。解凍したら，バンドとチャンネルに対応する変換テーブルを読み込みます。

```python
#  標準ライブラリbz2を使用して，ひまわり画像を開く。
with bz2.open(fname_hmwr) as bz2fin:
    buf_cnt = bz2fin.read()
    data_cnt = np.frombuffer(buf_cnt, dtype='>u2').reshape(n, n)
    
    data_tbb = cnt2tbb[data_cnt] # 画像データを変換テーブルで変換する
```

この部分は，bzip2で圧縮されているひまわり画像データを開いて，data\_cnt という二次元のndarray に格納している部分です。最終部分では，変換テーブルで輝度温度に変換しています。

```python
#------------------------------------------------------------------------------
# プロット
fig = plt.figure(figsize=(294/25.4, 210/25.4))
out_fig_path = f'{date}{time}-himawari_{band}{ch}.png'

fig.text(0.10, 0.97, f"{date} {time}UTC", fontsize=14)
fig.text(0.10, 0.94, f"BAND:{band}, CH:{ch}", fontsize=14)
#  図法の設定 (適宜コメントアウトを外して使ってください)
# mapcrs = ccrs.PlateCarree()
mapcrs = ccrs.NorthPolarStereo(central_longitude=140.0, true_scale_latitude=60.0) # 気象庁「日々の天気図」に近いもの
# mapcrs = ccrs.Robinson(central_longitude=180.0) # ロビンソン図法
# mapcrs = ccrs.Mercator() # メルカトル図法
# mapcrs = ccrs.Mollweide() # モルワイデ図法

ax = fig.add_axes([0.10, 0.10, 0.75, 0.75], projection=mapcrs)


# 海岸線や国境を描画する
ax.add_feature(cfeature.COASTLINE, linewidth=0.5, color="green")
ax.add_feature(cfeature.BORDERS, linewidth=0.5, linestyle=':', color="green")

# 地図を描く緯度経度の範囲の設定
ax.set_extent([117.0, 156.0, 18.0, 61.0], ccrs.PlateCarree())

# ひまわり衛星画像の描画
ax.imshow(data_tbb, origin='upper', extent=extent_hmwr, interpolation='none',cmap="gray_r", transform=ccrs.PlateCarree())

ax.gridlines(xlocs=np.arange(100, 180, 10), 
             ylocs=np.arange(10, 90, 10),
             linestyle='dashed', color='green', linewidth=0.5)

#------------------------------------------------------------------------------
# 図の保存
plt.savefig(out_fig_path, transparent=False)
```

この部分はCartopyで読み込んだひまわり画像データを描画している部分です。ファイル名や図の上部に日付やバンド，チャンネル番号をつけるようにしました。

気象庁ホームページの「日々の天気図」掲載の天気図と比較がしやすいように，ポーラーステレオ図法でプロットしています（ちなみに，[気象庁の資料](https://www.data.jma.go.jp/suishin/shiyou/pdf/no12203)によると，「北緯 60度、東経 140 度を基準としたポーラーステレオ図法で投影している」とのことですが，微妙にずれます… )。

## 最後に

以上のように，Pythonをつかって気象衛星が撮影した日本付近の画像をプロットすることができました。今回は，赤外線画像を使って雲の様子を眺めてみただけですが，バンドの組み合わせ等で有用な情報が得られます。また，画像処理のテクニックを用いることで，台風の位置をトラッキングしたりすることも可能でしょう。

次回は，ひまわり画像データと数値予報データの重ね書きの方法を紹介したいと思います。

最後に，このような価値の高い画像を (非営利または，出版物での利用に限るとはいえ) 無料で得られるようにしてくださった，気象衛星の開発，維持，そして画像データ公開に携わっている方々に感謝を申し上げます。

## 参考にしたサイト・資料

この記事を書くにあたって，以下のウェブサイトや資料を参考にしました。このような有益な情報や資料を無料で公開しているウェブサイトの管理者や資料を作成された方に感謝を申し上げます。

- Pythonによる気象データサイエンス：[](https://www.dpac.dpri.kyoto-u.ac.jp/enomoto/pymetds/index.html#)[https://www.dpac.dpri.kyoto-u.ac.jp/enomoto/pymetds/index.html](https://www.dpac.dpri.kyoto-u.ac.jp/enomoto/pymetds/index.html)
- 千葉大学リモートセンシング研究センター：[](http://www.cr.chiba-u.jp/databases/GEO/H8_9/FD/index_jp_V20190123.html)[http://www.cr.chiba-u.jp/databases/GEO/H8\_9/FD/index\_jp\_V20190123.html](http://www.cr.chiba-u.jp/databases/GEO/H8_9/FD/index_jp_V20190123.html)
- 第10回VL講習会＠千葉大・CEReS〜日本の地球観測衛星を知ろう〜：[](http://www.cr.chiba-u.jp/databases/VL/VL-Lecture2016/VL2016_ChibaUniversity_PartA.pdf)[http://www.cr.chiba-u.jp/databases/VL/VL-Lecture2016/VL2016\_ChibaUniversity\_PartA.pdf](http://www.cr.chiba-u.jp/databases/VL/VL-Lecture2016/VL2016_ChibaUniversity_PartA.pdf)
- Pythonによるひまわり8号データの可視化：[](https://www.jstage.jst.go.jp/article/rssj/41/4/41_493/_article/-char/ja/)[https://www.jstage.jst.go.jp/article/rssj/41/4/41\_493/\_article/-char/ja/](https://www.jstage.jst.go.jp/article/rssj/41/4/41_493/_article/-char/ja/)